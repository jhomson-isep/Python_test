<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record id="view_attachment_form" model="ir.ui.view">
        <field name="name">view.portal.my.purchase.order.inherit</field>
        <field name="inherit_id" ref="purchase.portal_my_purchase_order"/>
        <field name="arch" type="xml">
            <xpath expr="//div[@class='container']" position="after">

                <!-- modals -->
                <!-- modal relative to the actions sign and pay -->
                <div role="dialog" class="modal fade" id="modalaccept">
                    <div class="modal-dialog"
                         t-if="order.has_to_be_signed(True)">
                        <form id="accept" method="POST"
                              t-att-data-order-id="order.id"
                              t-att-data-token="order.access_token"
                              class="js_accept_json modal-content js_website_submit_form">
                            <input type="hidden" name="csrf_token"
                                   t-att-value="request.csrf_token()"/>
                            <header class="modal-header">
                                <h4 class="modal-title">Validate Order</h4>
                                <button type="button" class="close"
                                        data-dismiss="modal"
                                        aria-label="Close">&amp;times;</button>
                            </header>
                            <main class="modal-body" id="sign-dialog">
                                <p>
                                    <span>By signing this proposal, I agree to
                                        the following terms:</span>
                                    <ul>
                                        <li><span>Accepted on the behalf
                                            of:</span> <b
                                                t-field="order.partner_id.commercial_partner_id"/></li>
                                        <li><span>For an amount of:</span> <b
                                                data-id="total_amount"
                                                t-field="order.amount_total"/></li>
                                        <li t-if="order.payment_term_id"><span>
                                            With payment terms:</span> <b
                                                t-field="order.payment_term_id.note"/></li>
                                    </ul>
                                </p>
                                <t t-call="portal.portal_signature">
                                    <t t-set="object" t-value="order"/>
                                    <t t-set="partner_name"
                                       t-value="order.partner_id.name"/>
                                    <t t-set="callUrl"
                                       t-value="order.get_portal_url(suffix='/accept')"/>
                                    <t t-set="accessToken"
                                       t-value="order.access_token"/>
                                </t>
                            </main>
                        </form>
                    </div>

                    <div class="modal-dialog modal-content"
                         t-if="not order.has_to_be_signed(True)">
                        <header class="modal-header">
                            <h4 class="modal-title">Validate Order</h4>
                            <button type="button" class="close"
                                    data-dismiss="modal" aria-label="Close">
                                &amp;times;</button>
                        </header>
                        <main class="modal-body" id="sign-dialog">
                            <p>
                                <span>By paying this proposal, I agree to the
                                    following terms:</span>
                                <ul>
                                    <li><span>Accepted on the behalf
                                        of:</span> <b
                                            t-field="order.partner_id.commercial_partner_id"/></li>
                                    <li><span>For an amount of:</span> <b
                                            data-id="total_amount"
                                            t-field="order.amount_total"/></li>
                                    <li t-if="order.payment_term_id"><span>With
                                        payment terms:</span> <b
                                            t-field="order.payment_term_id.note"/></li>
                                </ul>
                            </p>
                            <div t-if="pms or acquirers" id="payment_method"
                                 class="text-left">
                                <h3 class="mb24">Pay with</h3>
                                <t t-call="payment.payment_tokens_list">
                                    <t t-set="mode" t-value="'payment'"/>
                                    <t t-set="submit_txt">Pay &amp; Confirm</t>
                                    <t t-set="icon_class" t-value="'fa-lock'"/>
                                    <t t-set="form_action"
                                       t-value="order.get_portal_url(suffix='/transaction/token')"/>
                                    <t t-set="prepare_tx_url"
                                       t-value="order.get_portal_url(suffix='/transaction/')"/>
                                    <t t-set="access_token"
                                       t-value="order.access_token"/>
                                </t>
                            </div>
                        </main>
                    </div>
                </div>

                <!-- modal relative to the action reject -->
                <div role="dialog" class="modal fade" id="modaldecline">
                    <div class="modal-dialog">
                        <form id="decline" method="POST"
                              t-attf-action="/my/orders/#{order.id}/decline?access_token=#{order.access_token}"
                              class="modal-content">
                            <input type="hidden" name="csrf_token"
                                   t-att-value="request.csrf_token()"/>
                            <header class="modal-header">
                                <h4 class="modal-title">Reject This
                                    Quotation</h4>
                                <button type="button" class="close"
                                        data-dismiss="modal"
                                        aria-label="Close">&amp;times;</button>
                            </header>
                            <main class="modal-body">
                                <p>
                                    Tell us why you are refusing this
                                    quotation, this will help us improve our
                                    services.
                                </p>
                                <textarea rows="4" name="decline_message"
                                          required=""
                                          placeholder="Your feedback..."
                                          class="form-control"/>
                            </main>
                            <footer class="modal-footer">
                                <button type="submit" t-att-id="order.id"
                                        class="btn btn-danger"><i
                                        class="fa fa-times"></i>
                                    Reject</button>
                                <button type="button" class="btn btn-primary"
                                        data-dismiss="modal">Cancel</button>
                            </footer>
                        </form>
                    </div>
                </div>

                <!-- status messages -->
                <div t-if="message == 'sign_ok'"
                     class="alert alert-success alert-dismissable d-print-none"
                     role="status">
                    <button type="button" class="close" data-dismiss="alert"
                            aria-label="Close">&amp;times;</button>
                    <strong>Thank You!</strong><br/>
                    <t t-if="message == 'sign_ok' and order.state in ['sale', 'done']">
                        Your order has been confirmed.</t>
                    <t t-elif="message == 'sign_ok'">Your order has been signed
                        but still needs to be paid to be confirmed.</t>
                    <t t-else="">Your order has been signed.</t>
                </div>

                <div t-if="message == 'cant_reject' and order.has_to_be_signed()"
                     class="alert alert-danger alert-dismissable d-print-none"
                     role="alert">
                    <button type="button" class="close" data-dismiss="alert"
                            aria-label="Close">&amp;times;</button>
                    Your order is not in a state to be rejected.
                </div>


                <div t-if="order.state == 'cancel'"
                     class="alert alert-danger alert-dismissable d-print-none"
                     role="alert">
                    <button type="button" class="close" data-dismiss="alert"
                            aria-label="close">&amp;times;</button>
                    <strong>This quotation has been canceled.</strong> <a
                        role="button" href="#discussion"><i
                        class="fa fa-comment"/> Contact us to get a new
                    quotation.</a>
                </div>

                <div t-if="order.state == 'draft'"
                     class="alert alert-warning alert-dismissable d-print-none"
                     role="status">
                    <button type="button" class="close" data-dismiss="alert"
                            aria-label="close">&amp;times;</button>
                    <strong>This is a draft quotation.</strong> <a
                        role="button" href="#discussion"><i
                        class="fa fa-comment"/> Contact us to get the final
                    version.</a>
                </div>

                <!-- bottom actions -->
                <div t-if="order.has_to_be_signed(True)"
                     class="row justify-content-center text-center d-print-none pt-1 pb-4">

                    <t t-if="order.has_to_be_signed(True)">
                        <div class="col-sm-auto mt8">
                            <a role="button" class="btn btn-primary"
                               data-toggle="modal" data-target="#modalaccept"
                               href="#"><i class="fa fa-check"/> Accept &amp;
                                Sign</a>
                        </div>
                        <div class="col-sm-auto mt8">
                            <a role="button" class="btn btn-secondary"
                               href="#discussion"><i class="fa fa-comment"/>
                                Feedback</a>
                        </div>
                        <div class="col-sm-auto mt8">
                            <a role="button" class="btn btn-danger"
                               data-toggle="modal" data-target="#modaldecline"
                               href="#"><i class="fa fa-times"/> Reject</a>
                        </div>
                    </t>
                    <div t-elif="order.has_to_be_signed(True)"
                         class="col-sm-auto mt8">
                        <a role="button" class="btn btn-primary"
                           data-toggle="modal" data-target="#modalaccept"
                           href="#">
                            <i class="fa fa-check"/> <t
                                t-if="not order.signature">
                            Accept &amp; Pay</t><t t-else="">Pay now</t>
                        </a>
                    </div>
                </div>

                <section t-if="order.signature" id="signature"
                         name="Signature">
                    <div class="row mt-4" name="signature">
                        <div t-attf-class="#{'col-3' if report_type != 'html' else 'col-sm-7 col-md-4'} ml-auto text-center">
                            <h5>Signature</h5>
                            <img t-att-src="image_data_uri(order.signature)"
                                 style="max-height: 6rem; max-width: 100%;"/>
                            <p t-field="order.signed_by"/>
                        </div>
                    </div>
                </section>

                <div class="mt32">
                    <h4><strong>Message and communication history</strong></h4>
                    <t t-call="portal.message_thread">
                        <t t-set="object" t-value="order"/>
                        <t t-set="token" t-value="order.access_token"/>
                        <t t-set="pid" t-value="pid"/>
                        <t t-set="hash" t-value="hash"/>
                    </t>
                </div>
            </xpath>
        </field>
    </record>
</odoo>